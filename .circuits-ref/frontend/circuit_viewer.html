<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Flow Viewer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #e94560;
            --success: #4caf50;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        h1 { color: var(--accent); margin-bottom: 10px; }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input-label {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        #file-input { display: none; }

        .prompt-box {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
            flex: 1;
            min-width: 300px;
        }

        .view-toggle { display: flex; gap: 5px; }

        .view-btn {
            background: var(--bg-secondary);
            border: 1px solid #444;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        #chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            min-height: 600px;
            position: relative;
        }

        .link {
            fill: none;
            stroke-opacity: 0.5;
        }

        .link:hover { stroke-opacity: 0.8; }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            max-width: 400px;
            z-index: 100;
            line-height: 1.5;
            border: 1px solid #444;
        }

        .tooltip .title {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }

        .detail-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 420px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 2px solid var(--accent);
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 200;
        }

        .detail-panel.open { transform: translateX(0); }

        .detail-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
        }

        .detail-panel h2 {
            color: var(--accent);
            margin-top: 0;
        }

        .detail-panel .neuron-list {
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 4px;
        }

        .detail-panel .neuron-item {
            background: var(--bg-primary);
            padding: 8px 10px;
            margin: 2px;
            border-radius: 4px;
            line-height: 1.4;
        }

        .detail-panel .neuron-loc {
            color: var(--accent);
            font-family: monospace;
            font-weight: bold;
        }

        .detail-panel .neuron-inf {
            color: var(--success);
            font-size: 10px;
            margin-left: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: var(--text-secondary);
        }

        .debug-info {
            background: #333;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Circuit Flow Viewer</h1>

        <div class="controls">
            <label class="file-input-label" for="file-input">Load Analysis JSON</label>
            <input type="file" id="file-input" accept=".json">
            <div class="prompt-box" id="prompt-display">Load an analysis JSON to view the circuit flow</div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="sankey">Sankey</button>
                <button class="view-btn" data-view="layered">Layered</button>
            </div>
        </div>

        <div id="chart-container">
            <div class="empty-state">
                <h2>No data loaded</h2>
                <p>Load a module analysis JSON file to visualize the circuit flow.</p>
            </div>
        </div>

        <div class="detail-panel" id="detail-panel">
            <button class="close-btn" onclick="closeDetailPanel()">&times;</button>
            <h2 id="detail-title">Module Details</h2>
            <div id="detail-content"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentView = 'sankey';

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentData = JSON.parse(e.target.result);
                    console.log('Loaded data:', currentData);
                    document.getElementById('prompt-display').textContent = currentData.prompt || 'Unknown prompt';
                    render();
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.view;
                if (currentData) render();
            });
        });

        function render() {
            if (currentView === 'sankey') {
                renderSankey();
            } else {
                renderLayered();
            }
        }

        function renderSankey() {
            const container = document.getElementById('chart-container');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = 600;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const modules = currentData.module_summaries || [];
            const edges = currentData.module_edges || [];

            console.log('Modules:', modules.length, 'Edges:', edges.length);

            if (modules.length === 0) {
                container.innerHTML = '<div class="empty-state"><h2>No modules found</h2></div>';
                return;
            }

            // Collect unique tokens
            const tokenMap = new Map();
            modules.forEach(m => {
                (m.top_tokens || []).forEach(t => {
                    const tok = t[0];
                    if (tok && !tok.startsWith('<|') && tok !== ':' && tok.length > 0) {
                        tokenMap.set(tok, (tokenMap.get(tok) || 0) + t[1]);
                    }
                });
            });
            const tokens = Array.from(tokenMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(t => t[0]);

            console.log('Tokens:', tokens);

            // Build nodes
            const nodes = [];
            const nodeMap = new Map();

            // Token nodes
            tokens.forEach((t, i) => {
                const id = 'tok_' + i;
                nodeMap.set(id, nodes.length);
                nodes.push({ id, name: t, type: 'token' });
            });

            // Module nodes
            modules.forEach(m => {
                const id = 'mod_' + m.cluster_id;
                nodeMap.set(id, nodes.length);
                nodes.push({
                    id,
                    name: 'M' + m.cluster_id,
                    type: 'module',
                    moduleData: m
                });
            });

            // Output node
            nodeMap.set('output', nodes.length);
            nodes.push({ id: 'output', name: 'Output', type: 'output' });

            console.log('Nodes:', nodes.length);

            // Build links
            const links = [];

            // Token -> Module
            modules.forEach(m => {
                (m.top_tokens || []).forEach(t => {
                    const tokIdx = tokens.indexOf(t[0]);
                    if (tokIdx >= 0) {
                        const srcId = 'tok_' + tokIdx;
                        const tgtId = 'mod_' + m.cluster_id;
                        if (nodeMap.has(srcId) && nodeMap.has(tgtId)) {
                            links.push({
                                source: nodeMap.get(srcId),
                                target: nodeMap.get(tgtId),
                                value: Math.max(0.5, t[1]),
                                linkType: 'token-module'
                            });
                        }
                    }
                });
            });

            // Module -> Module
            edges.forEach(e => {
                const srcId = 'mod_' + e.source;
                const tgtId = 'mod_' + e.target;
                if (nodeMap.has(srcId) && nodeMap.has(tgtId)) {
                    links.push({
                        source: nodeMap.get(srcId),
                        target: nodeMap.get(tgtId),
                        value: Math.max(0.2, Math.abs(e.weight)),
                        weight: e.weight,
                        linkType: 'module-module'
                    });
                }
            });

            // Last modules -> Output
            const maxLayer = Math.max(...modules.map(m => m.layer_mean));
            modules.filter(m => m.layer_mean > maxLayer * 0.7).forEach(m => {
                const srcId = 'mod_' + m.cluster_id;
                if (nodeMap.has(srcId)) {
                    links.push({
                        source: nodeMap.get(srcId),
                        target: nodeMap.get('output'),
                        value: Math.max(0.5, Math.abs(m.total_influence) * 0.05),
                        linkType: 'module-output'
                    });
                }
            });

            console.log('Links:', links.length);

            if (links.length === 0) {
                container.innerHTML = '<div class="empty-state"><h2>No links to display</h2><p>Check console for debug info</p></div>';
                return;
            }

            // Sankey layout
            const sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(12)
                .extent([[60, 30], [width - 60, height - 30]]);

            try {
                const graph = sankey({
                    nodes: nodes.map(d => Object.assign({}, d)),
                    links: links.map(d => Object.assign({}, d))
                });

                // Draw links
                svg.append('g')
                    .selectAll('path')
                    .data(graph.links)
                    .join('path')
                    .attr('class', 'link')
                    .attr('d', d3.sankeyLinkHorizontal())
                    .attr('stroke-width', d => Math.max(2, d.width))
                    .attr('stroke', d => {
                        if (d.linkType === 'module-module') {
                            return d.weight > 0 ? '#4caf50' : '#e94560';
                        }
                        return '#666';
                    })
                    .on('mouseover', (event, d) => showLinkTooltip(event, d))
                    .on('mouseout', hideTooltip);

                // Draw nodes
                const node = svg.append('g')
                    .selectAll('g')
                    .data(graph.nodes)
                    .join('g')
                    .attr('transform', d => `translate(${d.x0},${d.y0})`)
                    .style('cursor', d => d.type === 'module' ? 'pointer' : 'default')
                    .on('click', (event, d) => {
                        if (d.type === 'module' && d.moduleData) {
                            showModuleDetail(d.moduleData);
                        }
                    })
                    .on('mouseover', (event, d) => showNodeTooltip(event, d))
                    .on('mouseout', hideTooltip);

                node.append('rect')
                    .attr('width', d => d.x1 - d.x0)
                    .attr('height', d => Math.max(1, d.y1 - d.y0))
                    .attr('fill', d => {
                        if (d.type === 'token') return '#0f4c75';
                        if (d.type === 'output') return '#e94560';
                        const layer = d.moduleData ? d.moduleData.layer_mean / 32 : 0.5;
                        return d3.interpolateViridis(layer);
                    })
                    .attr('stroke', '#222')
                    .attr('stroke-width', 1);

                // Node labels
                node.append('text')
                    .attr('x', d => d.type === 'token' ? -6 : (d.x1 - d.x0) + 6)
                    .attr('y', d => (d.y1 - d.y0) / 2)
                    .attr('dy', '0.35em')
                    .attr('text-anchor', d => d.type === 'token' ? 'end' : 'start')
                    .attr('fill', '#eee')
                    .attr('font-size', 11)
                    .text(d => {
                        if (d.type === 'module' && d.moduleData) {
                            const m = d.moduleData;
                            return `M${m.cluster_id} L${m.layer_range[0]}-${m.layer_range[1]}`;
                        }
                        return d.name;
                    });

            } catch (err) {
                console.error('Sankey error:', err);
                container.innerHTML = `<div class="empty-state"><h2>Rendering error</h2><p>${err.message}</p></div>`;
            }

            addLegend(container);
        }

        function renderLayered() {
            const container = document.getElementById('chart-container');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = 650;
            const margin = { top: 80, right: 80, bottom: 60, left: 80 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const modules = currentData.module_summaries || [];
            const edges = currentData.module_edges || [];

            if (modules.length === 0) {
                container.innerHTML = '<div class="empty-state"><h2>No modules found</h2></div>';
                return;
            }

            // Scales
            const maxLayer = Math.max(...modules.map(m => m.layer_range[1])) || 32;
            const xScale = d3.scaleLinear()
                .domain([0, maxLayer])
                .range([margin.left, width - margin.right]);

            // Position modules
            const sortedModules = [...modules].sort((a, b) => a.layer_mean - b.layer_mean);
            const yStep = (height - margin.top - margin.bottom) / (sortedModules.length + 1);
            sortedModules.forEach((m, i) => {
                m._x = xScale(m.layer_mean);
                m._y = margin.top + yStep * (i + 1);
                m._r = Math.max(20, Math.sqrt(m.size) * 6);
            });

            // Create module lookup
            const moduleById = new Map();
            sortedModules.forEach(m => moduleById.set(m.cluster_id, m));

            // Draw edges
            const edgeGroup = svg.append('g');
            edges.forEach(e => {
                const src = moduleById.get(e.source);
                const tgt = moduleById.get(e.target);
                if (src && tgt) {
                    const midX = (src._x + tgt._x) / 2;
                    const midY = (src._y + tgt._y) / 2 - 20;

                    edgeGroup.append('path')
                        .attr('d', `M${src._x},${src._y} Q${midX},${midY} ${tgt._x},${tgt._y}`)
                        .attr('fill', 'none')
                        .attr('stroke', e.weight > 0 ? '#4caf50' : '#e94560')
                        .attr('stroke-width', Math.max(1.5, Math.abs(e.weight) * 1.5))
                        .attr('stroke-opacity', 0.6)
                        .attr('marker-end', 'url(#arrowhead)');
                }
            });

            // Arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 8)
                .attr('refY', 0)
                .attr('markerWidth', 5)
                .attr('markerHeight', 5)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#888');

            // Draw module nodes
            const nodeGroup = svg.selectAll('.module-node')
                .data(sortedModules)
                .join('g')
                .attr('class', 'module-node')
                .attr('transform', d => `translate(${d._x},${d._y})`)
                .style('cursor', 'pointer')
                .on('click', (event, d) => showModuleDetail(d))
                .on('mouseover', (event, d) => showModuleTooltip(event, d))
                .on('mouseout', hideTooltip);

            nodeGroup.append('circle')
                .attr('r', d => d._r)
                .attr('fill', d => d3.interpolateViridis(d.layer_mean / maxLayer))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .attr('opacity', 0.9);

            nodeGroup.append('text')
                .attr('dy', 4)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', 12)
                .attr('font-weight', 'bold')
                .text(d => `M${d.cluster_id}`);

            nodeGroup.append('text')
                .attr('y', d => d._r + 14)
                .attr('text-anchor', 'middle')
                .attr('fill', '#aaa')
                .attr('font-size', 10)
                .text(d => `L${d.layer_range[0]}-${d.layer_range[1]}`);

            // X axis
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom + 20})`)
                .call(d3.axisBottom(xScale).ticks(8))
                .selectAll('text, line, path')
                .attr('stroke', '#666')
                .attr('fill', '#aaa');

            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 15)
                .attr('fill', '#aaa')
                .attr('text-anchor', 'middle')
                .text('Layer');

            // Title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 30)
                .attr('fill', '#eee')
                .attr('text-anchor', 'middle')
                .attr('font-size', 16)
                .text('Module Flow by Layer');

            addLegend(container);
        }

        function addLegend(container) {
            const legend = document.createElement('div');
            legend.className = 'legend';
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50"></div>
                    <span>Excitatory</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e94560"></div>
                    <span>Inhibitory</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(90deg, #440154, #21918c, #fde725)"></div>
                    <span>Layer depth</span>
                </div>
            `;
            container.appendChild(legend);
        }

        function showNodeTooltip(event, d) {
            let html = `<div class="title">${d.name || d.id}</div>`;

            if (d.type === 'module' && d.moduleData) {
                const m = d.moduleData;
                html += `
                    <div><b>Layers:</b> ${m.layer_range[0]}-${m.layer_range[1]} (mean: ${m.layer_mean.toFixed(1)})</div>
                    <div><b>Neurons:</b> ${m.size}</div>
                    <div><b>Influence:</b> ${m.total_influence.toFixed(2)}</div>
                    <div><b>Flow:</b> in=${m.incoming_flow.toFixed(2)}, out=${m.outgoing_flow.toFixed(2)}</div>
                    <div><b>Tokens:</b> ${(m.top_tokens || []).map(t => "'" + t[0] + "'").join(', ') || 'none'}</div>
                `;
            } else if (d.type === 'token') {
                html += `<div>Input token</div>`;
            } else if (d.type === 'output') {
                html += `<div>Model output</div>`;
            }

            showTooltip(event, html);
        }

        function showModuleTooltip(event, m) {
            const html = `
                <div class="title">Module ${m.cluster_id}</div>
                <div><b>Layers:</b> ${m.layer_range[0]}-${m.layer_range[1]} (mean: ${m.layer_mean.toFixed(1)})</div>
                <div><b>Neurons:</b> ${m.size}</div>
                <div><b>Influence:</b> ${m.total_influence.toFixed(2)}</div>
                <div><b>Flow:</b> in=${m.incoming_flow.toFixed(2)}, out=${m.outgoing_flow.toFixed(2)}</div>
                <div><b>Tokens:</b> ${(m.top_tokens || []).map(t => "'" + t[0] + "'").join(', ') || 'none'}</div>
                <div style="margin-top:8px;color:#888;font-size:10px;">Click for all neurons</div>
            `;
            showTooltip(event, html);
        }

        function showLinkTooltip(event, d) {
            let html = `<div class="title">Flow Connection</div>`;
            if (d.weight !== undefined) {
                html += `<div><b>Weight:</b> ${d.weight.toFixed(3)}</div>`;
                html += `<div><b>Type:</b> ${d.weight > 0 ? 'Excitatory (+)' : 'Inhibitory (-)'}</div>`;
            }
            if (d.linkType) {
                html += `<div><b>Connection:</b> ${d.linkType}</div>`;
            }
            showTooltip(event, html);
        }

        function showTooltip(event, html) {
            let tooltip = document.querySelector('.tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                document.body.appendChild(tooltip);
            }
            tooltip.innerHTML = html;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) tooltip.style.display = 'none';
        }

        function showModuleDetail(m) {
            const panel = document.getElementById('detail-panel');
            document.getElementById('detail-title').textContent = `Module ${m.cluster_id}`;

            const neurons = m.all_neurons || m.top_neurons || [];
            const tokensStr = (m.top_tokens || []).map(t => `'${t[0]}' (${t[1]})`).join(', ') || 'none';

            let html = `
                <div style="margin-bottom: 15px; line-height: 1.8;">
                    <div><b>Layers:</b> ${m.layer_range[0]}-${m.layer_range[1]} (mean: ${m.layer_mean.toFixed(1)})</div>
                    <div><b>Neurons:</b> ${m.size}</div>
                    <div><b>Influence:</b> ${m.total_influence.toFixed(2)}</div>
                    <div><b>Flow:</b> in=${m.incoming_flow.toFixed(2)}, out=${m.outgoing_flow.toFixed(2)}</div>
                    <div><b>Tokens:</b> ${tokensStr}</div>
                </div>
                <h3 style="margin-bottom:10px;">All ${neurons.length} Neurons</h3>
                <div class="neuron-list">
                    ${neurons.map(n => `
                        <div class="neuron-item">
                            <span class="neuron-loc">L${n.layer}/N${n.neuron}</span>
                            <span class="neuron-inf">(inf: ${(n.influence || 0).toFixed(2)})</span>
                            <div style="margin-top:4px;color:#ccc;">${n.label || 'No label'}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('detail-content').innerHTML = html;
            panel.classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('open');
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeDetailPanel();
        });
    </script>
</body>
</html>
