<!DOCTYPE html>
<html>
<head>
    <title>Cluster Component Distribution</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/notif.css">
    <link rel="stylesheet" href="css/model-view.css">
    <style>
        #controls {
            margin: 10px;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        #controls select, #controls input {
            margin: 0 5px;
            padding: 2px;
            font-size: 11px;
        }

        #tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: pre-line;
            z-index: 100;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Cluster Component Distribution</h1>

    <div id="controls">
        <label>Cluster Hash: <input type="text" id="clusterInput" placeholder="cluster-hash"></label>
        <label>Colormap:
            <select id="colormapSelect">
                <option value="blues">Blues</option>
                <option value="reds">Reds</option>
                <option value="viridis">Viridis</option>
                <option value="plasma">Plasma</option>
            </select>
        </label>
    </div>

    <div id="loading">Loading model data...</div>
    <div id="modelContainer" class="modelview-container"></div>

    <div id="tooltip"></div>

    <div style="margin: 20px;">
        <a href="index.html">‚Üê Back to Cluster Selection</a>
    </div>

    <script src="js/util/notif.js"></script>
    <script src="js/util/config.js"></script>
    <script src="js/util/ColorUtil.js"></script>
    <script src="js/pkg/jszip.min.js"></script>
    <script src="js/model-visualization.js"></script>
    <script>
        let clusterData = {};
        let modelInfo = {};
        let currentClusterHash = null;
        let currentColormap = 'blues';

        async function loadData() {
            const progressBar = NOTIF.pbar('Loading data...');
            try {
                await initConfig();
                progressBar.progress(0.2);

                const [clusters, modelInfoResponse] = await Promise.all([
                    loadJSONL(CONFIG.getDataPath('clusters'), 'cluster_hash'),
                    fetch(CONFIG.getDataPath('modelInfo'))
                ]);

                progressBar.progress(0.6);

                if (!modelInfoResponse.ok) {
                    throw new Error(`Failed to load model info: ${modelInfoResponse.status}`);
                }

                clusterData = clusters;
                modelInfo = await modelInfoResponse.json();

                progressBar.progress(0.9);

                // Set default cluster to first available
                const clusterHashes = Object.keys(clusterData);
                if (clusterHashes.length > 0 && currentClusterHash === null) {
                    currentClusterHash = clusterHashes[0];
                    document.getElementById('clusterInput').value = currentClusterHash;
                }

                renderView();
                progressBar.complete();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                progressBar.complete();
                NOTIF.error('Error loading data', error, null);
                document.getElementById('loading').textContent = 'Error loading data: ' + error.message;
            }
        }

        function renderView() {
            if (currentClusterHash === null || !clusterData[currentClusterHash]) {
                document.getElementById('modelContainer').innerHTML = '<div>No cluster selected or cluster not found</div>';
                return;
            }

            const container = document.getElementById('modelContainer');
            renderModelView(container, currentClusterHash, clusterData, modelInfo, currentColormap, CONFIG.visualization.modelViewCellSize);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('clusterInput').addEventListener('change', (e) => {
                currentClusterHash = e.target.value;
                renderView();
            });

            document.getElementById('colormapSelect').addEventListener('change', (e) => {
                currentColormap = e.target.value;
                renderView();
            });

            loadData();
        });
    </script>
</body>
</html>